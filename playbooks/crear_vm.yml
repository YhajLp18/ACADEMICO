---
# =====================================================
# ğŸ§° CREAR MÃQUINA VIRTUAL EN VMWARE (AVANZADO)
# =====================================================

- name: "ğŸš€ Crear nueva mÃ¡quina virtual en VMware ESXi"
  hosts: localhost
  gather_facts: false

  vars:
    # === ğŸ” CREDENCIALES DE ESXi ===
    esxi_hostname: "172.17.25.121"
    esxi_user: "root"
    esxi_pass: "TuClave"
    datastore: "datastore1"
    portgroup: "VM Network"
    validate_certs: false

    # === âš™ï¸ CONFIGURACIÃ“N GENERAL DE VM ===
    vm_name: "VM-Academico-Ubuntu"     # cambia el nombre
    os_type: "ubuntu"                  # opciones: ubuntu / windows
    vm_cpu: 2
    vm_ram_mb: 4096
    vm_disk_gb: 40
    folder: "/"

    # === ğŸ“€ RUTA DEL ISO SEGÃšN TIPO DE SISTEMA ===
    iso_path_ubuntu: "[datastore1] iso/ubuntu-24.04.3-live-server-amd64.iso"
    iso_path_windows: "[datastore1] iso/Win11.iso"

  tasks:

    - name: "ğŸ“¡ Conectando con el host ESXi"
      community.vmware.vmware_about_info:
        hostname: "{{ esxi_hostname }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_pass }}"
        validate_certs: "{{ validate_certs }}"
      register: about
    - debug:
        msg: "Conectado a {{ about.about.name }} versiÃ³n {{ about.about.version }}"

    - name: "ğŸ§± Definir parÃ¡metros segÃºn sistema operativo"
      set_fact:
        guest_id: "{{ 'ubuntu64Guest' if os_type == 'ubuntu' else 'windows9Server64Guest' }}"
        iso_path: "{{ iso_path_ubuntu if os_type == 'ubuntu' else iso_path_windows }}"
      tags: always

    - name: "ğŸ–¥ï¸ Crear mÃ¡quina virtual"
      community.vmware.vmware_guest:
        hostname: "{{ esxi_hostname }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_pass }}"
        validate_certs: "{{ validate_certs }}"
        name: "{{ vm_name }}"
        state: poweredon
        guest_id: "{{ guest_id }}"
        disk:
          - size_gb: "{{ vm_disk_gb }}"
            type: thin
            datastore: "{{ datastore }}"
        hardware:
          memory_mb: "{{ vm_ram_mb }}"
          num_cpus: "{{ vm_cpu }}"
          scsi: paravirtual
        networks:
          - name: "{{ portgroup }}"
            device_type: vmxnet3
        cdrom:
          type: iso
          iso_path: "{{ iso_path }}"
        folder: "{{ folder }}"
        wait_for_ip_address: no
      register: vm_creation

    - name: "ğŸ“Š Resultado de creaciÃ³n"
      debug:
        msg: |
          âœ… VM creada: {{ vm_creation.instance.hw_name }}
          ğŸ’¾ Datastore: {{ datastore }}
          ğŸŒ Red: {{ portgroup }}
          ğŸ”Œ Estado: {{ vm_creation.instance.hw_power_status }}

    - name: "ğŸ§  Mensaje final"
      debug:
        msg: |
          ğŸ¯ VM {{ vm_name }} creada exitosamente.
          Puedes verla en tu host ESXi: {{ esxi_hostname }}
