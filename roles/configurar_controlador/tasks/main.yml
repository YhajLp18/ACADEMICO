---
# ====== 0) Detectar usuario y rutas base ======
- name: "ğŸ” Detectar usuario del controlador"
  set_fact:
    controller_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) | default(controller_user_fallback) }}"
    repo_root: "/home/{{ ansible_env.SUDO_USER | default(ansible_user_id) | default(controller_user_fallback) }}/{{ repo_name }}"

- name: "ğŸ“ Crear /etc/ansible si no existe"
  file:
    path: /etc/ansible
    state: directory
    owner: root
    group: root
    mode: '0755'

# ====== 1) Sistema base ======
- name: "ğŸ§± [1/12] Actualizando repositorios del sistema"
  apt:
    update_cache: yes
  changed_when: false

- name: "ğŸ”§ [2/12] Instalando dependencias bÃ¡sicas"
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - git
      - openssh-client
      - curl
      - vim
      - net-tools
      - software-properties-common
    state: present
  tags: deps

- name: "ğŸ“¦ [3/12] Instalando Ansible"
  apt:
    name: ansible
    state: present

# ====== 2) Virtualenv para evitar PEP 668 ======
- name: "ğŸ“ Crear entorno virtual en /opt/ansible-venv"
  command: python3 -m venv /opt/ansible-venv
  args:
    creates: /opt/ansible-venv/bin/python

- name: "â¬†ï¸ Actualizar pip/setuptools/wheel dentro del venv"
  pip:
    name:
      - pip
      - setuptools
      - wheel
    state: latest
    virtualenv: /opt/ansible-venv
    virtualenv_command: python3 -m venv

- name: "ğŸ“¦ [4/12] Instalar librerÃ­as Python necesarias dentro del venv"
  pip:
    name:
      - pyvmomi
      - pywinrm
      - requests
      - jmespath
      - passlib
    state: present
    virtualenv: /opt/ansible-venv
    virtualenv_command: python3 -m venv

# (opcional) Si quieres que el venv pertenezca al usuario no-root
- name: "ğŸ”’ Asignar permisos correctos al venv"
  file:
    path: /opt/ansible-venv
    state: directory
    recurse: yes
    owner: "{{ controller_user }}"
    group: "{{ controller_user }}"

# ====== 3) SSH y estructura ======
- name: "ğŸ“ Crear carpeta .ssh si no existe"
  file:
    path: "/home/{{ controller_user }}/.ssh"
    state: directory
    mode: '0700'
    owner: "{{ controller_user }}"
    group: "{{ controller_user }}"

- name: "ğŸ”‘ [5/12] Generar par de claves SSH (si no existe)"
  openssh_keypair:
    path: "/home/{{ controller_user }}/.ssh/id_rsa"
    type: rsa
    size: 2048
    owner: "{{ controller_user }}"
    mode: '0600'
  register: ssh_key

- name: "ğŸ“‚ [6/12] Crear carpeta para proyectos Ansible"
  file:
    path: "/home/{{ controller_user }}/ansible-proyectos"
    state: directory
    mode: '0755'
    owner: "{{ controller_user }}"

- name: "ğŸ“œ [7/12] Mostrar clave pÃºblica generada"
  debug:
    msg: "{{ lookup('file', '/home/' + controller_user + '/.ssh/id_rsa.pub') }}"

# ====== 4) ansible.cfg apuntando a TU repo ======
- name: "âš™ï¸ [8/12] Configurar /etc/ansible/ansible.cfg"
  copy:
    dest: /etc/ansible/ansible.cfg
    content: |
      [defaults]
      inventory = {{ repo_root }}/inventories/hosts.ini
      roles_path = {{ repo_root }}/roles
      host_key_checking = False
      retry_files_enabled = False
      interpreter_python = /opt/ansible-venv/bin/python
      stdout_callback = yaml
    owner: root
    group: root
    mode: '0644'

# ====== 5) Colecciones ======
- name: "ğŸ“¦ [9/12] Instalar colecciÃ³n community.vmware desde Galaxy"
  ansible.builtin.command: ansible-galaxy collection install community.vmware
  register: vmware_install
  changed_when: "'Successfully installed' in vmware_install.stdout or 'already installed' in vmware_install.stdout"

# ====== 6) VerificaciÃ³n ======
- name: "ğŸ“Š [10/12] Verificar instalaciÃ³n de Ansible"
  command: ansible --version
  register: ansible_version
  changed_when: false

- name: "ğŸ“Š [11/12] Verificar colecciones de Ansible Galaxy"
  command: ansible-galaxy collection list
  register: collections_list
  changed_when: false

- name: "ğŸ§© [12/12] RESULTADO FINAL"
  debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… InstalaciÃ³n completa del controlador Ansible
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ‘¤ Usuario controlador: {{ controller_user }}
      ğŸ“‚ Repo raÃ­z configurado: {{ repo_root }}
      ğŸ§  VersiÃ³n de Ansible:
      {{ ansible_version.stdout }}
      ğŸ§± Colecciones (vmware):
      {{ collections_list.stdout | regex_search('community.vmware[^\n]*', multiline=True) }}
      ğŸ—ï¸ Clave pÃºblica SSH:
      /home/{{ controller_user }}/.ssh/id_rsa.pub
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
