---
- name: "ğŸ§± [1/12] Actualizando repositorios del sistema"
  apt:
    update_cache: yes
  changed_when: false

- name: "ğŸ”§ [2/12] Instalando dependencias bÃ¡sicas"
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - git
      - openssh-client
      - curl
      - vim
      - net-tools
      - software-properties-common
    state: present
  tags: deps

- name: "ğŸ“¦ [3/12] Instalando Ansible"
  apt:
    name: ansible
    state: present

# CAMBIO AQUÃ ğŸ‘‡ğŸ‘‡ğŸ‘‡
- name: "ğŸ [4/12] Creando entorno virtual para Ansible y librerÃ­as Python"
  block:

    - name: "ğŸ“ Crear entorno virtual en /opt/ansible-venv"
      command: python3 -m venv /opt/ansible-venv
      args:
        creates: /opt/ansible-venv/bin/python

    - name: "â¬†ï¸ Actualizar pip/setuptools/wheel dentro del venv"
      pip:
        name:
          - pip
          - setuptools
          - wheel
        state: latest
        virtualenv: /opt/ansible-venv
        virtualenv_command: python3 -m venv

    - name: "ğŸ“¦ Instalar librerÃ­as Python necesarias dentro del venv"
      pip:
        name:
          - pyvmomi
          - pywinrm
          - requests
          - jmespath
          - passlib
        state: present
        virtualenv: /opt/ansible-venv
        virtualenv_command: python3 -m venv

    - name: "ğŸ”’ Asignar permisos correctos al venv"
      file:
        path: /opt/ansible-venv
        state: directory
        recurse: yes
        owner: "{{ ansible_user | default('ubuntu') }}"
        group: "{{ ansible_user | default('ubuntu') }}"
# CAMBIO AQUÃ â˜ï¸â˜ï¸â˜ï¸

- name: "ğŸ“‚ [5/12] Creando estructura de carpetas para proyectos Ansible"
  file:
    path: "/home/{{ ansible_user }}/ansible-proyectos"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"

- name: "ğŸ”‘ [6/12] Generando par de claves SSH (para conexiÃ³n con otros hosts)"
  openssh_keypair:
    path: "/home/{{ ansible_user }}/.ssh/id_rsa"
    type: rsa
    size: 2048
    owner: "{{ ansible_user }}"
    mode: '0600'
  register: ssh_key

- name: "ğŸ“œ [7/12] Mostrando clave pÃºblica generada"
  debug:
    msg: "{{ lookup('file', '/home/' + ansible_user + '/.ssh/id_rsa.pub') }}"

- name: "âš™ï¸ [8/12] Configurando ansible.cfg global"
  copy:
    dest: /etc/ansible/ansible.cfg
    content: |
      [defaults]
      inventory = /home/{{ ansible_user }}/ansible-controller-setup/inventories/hosts.ini
      roles_path = /home/{{ ansible_user }}/ansible-controller-setup/roles
      host_key_checking = False
      retry_files_enabled = False
      interpreter_python = /opt/ansible-venv/bin/python
      stdout_callback = yaml
    owner: root
    group: root
    mode: '0644'

- name: "ğŸ“¦ [9/12] Instalando colecciÃ³n community.vmware desde Galaxy"
  ansible.builtin.command: ansible-galaxy collection install community.vmware
  register: vmware_install
  changed_when: "'Successfully installed' in vmware_install.stdout or 'already installed' in vmware_install.stdout"

- name: "ğŸ“Š [10/12] Verificando instalaciÃ³n de Ansible"
  command: ansible --version
  register: ansible_version
  changed_when: false

- name: "ğŸ“Š [11/12] Verificando instalaciÃ³n de community.vmware"
  command: ansible-galaxy collection list
  register: collections_list
  changed_when: false

- name: "ğŸ§© [12/12] RESULTADO FINAL"
  debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… InstalaciÃ³n completa del controlador Ansible
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ§  VersiÃ³n de Ansible instalada:
      {{ ansible_version.stdout }}
      ğŸ§± Colecciones disponibles:
      {{ collections_list.stdout | regex_search('community.vmware[^\n]*', multiline=True) }}
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ğŸ¯ Controlador listo para usar con Linux, Windows y VMware
      ğŸ—ï¸ Clave pÃºblica SSH disponible en:
      /home/{{ ansible_user }}/.ssh/id_rsa.pub
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
